@if (Verses.Count > 0)
{
    <p id="verseText" class="w-full highlighted p-2 leading-9 bg-primary text-white_light" tabindex="0" @onkeydown="KeyPress">
        @foreach(var verse in Verses)
        {
            <span class="hidden h-0">
                @{
                    bool isHighlighted = Verse == verse;
                }
            </span>

            <span class="cursor-pointer px-2 py-1 m-2 @(isHighlighted ? "text-orange bg-gray_darkest" : "bg-gray")" @onclick="async () => { await SelectionChanged(verse); }">
                @verse
            </span>
        }
    </p>
}


@code {
    [Inject] IJSRuntime JS { get; set; }
    private List<string> verses;
    [Parameter] public List<string> Verses { get; set; }
    [Parameter] public EventCallback<string> SelectedVerse { get; set; }
    [Parameter] public string Verse { get; set; } = "";

    bool fromEnter;

    protected override void OnParametersSet()
    {
        if (verses != Verses)
        {
            if (!fromEnter)
                Verse = "";
            verses = Verses;
        }
    }

    private static VerseTextList verseTextList;
    public VerseTextList()
    {
        verseTextList = this;
    }

    private int ItemCount = 0;
    private int LastIndex = 0;

    private async Task SelectionChanged(string verse)
    {
        Verse = verse;

        await SelectedVerse.InvokeAsync(verse);

        LastIndex = Verses.FindIndex(v => v == verse);
    }

    private async Task KeyPress(KeyboardEventArgs args)
    {
        try
        {
            int index = Verses.FindIndex(v => v == Verse);
            if (args.Code == "ArrowDown")
            {
                if (index == Verses.Count - 1)
                {
                    await JS.InvokeVoidAsync("nextVerse", false);
                }
                index += ((index += 1) >= Verses.Count) ? 0 : 1;
            }
            else if (args.Code == "ArrowUp")
            {
                if (index == 0)
                {
                    await JS.InvokeVoidAsync("nextVerse", true);
                }
                index -= ((index -= 1) < 0) ? 0 : 1;
            }
            if (args.Code == "Enter") await JS.InvokeVoidAsync("focusInput", "chapter");


            await SelectionChanged(Verses[index]);

        }
        catch (Exception ex)
        {

        }
    }

    [JSInvokable]
    public static async void JStoCSCallverseText()
    {
        await verseTextList.SelectionChanged(verseTextList.Verses[0]);
    }

}
